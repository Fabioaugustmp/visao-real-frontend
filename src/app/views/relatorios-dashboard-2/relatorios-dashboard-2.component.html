<c-row>
  <!-- Filter Section -->
  <c-col xs="12">
    <c-card class="mb-4 filter-card">
      <c-card-header class="bg-gradient-primary text-white d-flex justify-content-between align-items-center"
        style="cursor: pointer;" (click)="toggleFilter()">
        <h5 class="mb-0">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-funnel me-2"
            viewBox="0 0 16 16">
            <path
              d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2zm1 .5v1.308l4.372 4.858A.5.5 0 0 1 7 8.5v5.306l2-.666V8.5a.5.5 0 0 1 .128-.334L13.5 3.308V2h-11z" />
          </svg>
          Filtros de Pesquisa
        </h5>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-chevron-down"
          viewBox="0 0 16 16" [style.transform]="isFilterCollapsed ? 'rotate(0deg)' : 'rotate(180deg)'"
          style="transition: transform 0.3s ease;">
          <path fill-rule="evenodd"
            d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
        </svg>
      </c-card-header>
      <c-card-body [hidden]="isFilterCollapsed">
        <form [formGroup]="filterForm" cForm>
          <c-row>
            <!-- Date Range -->
            <c-col md="3">
              <div class="mb-3">
                <label cLabel for="startDate" class="form-label">Data Início</label>
                <input cFormControl type="date" id="startDate" formControlName="startDate" class="form-control">
              </div>
            </c-col>
            <c-col md="3">
              <div class="mb-3">
                <label cLabel for="finishDate" class="form-label">Data Fim</label>
                <input cFormControl type="date" id="finishDate" formControlName="finishDate" class="form-control">
              </div>
            </c-col>

            <!-- Medico Dropdown (Admin Only) -->
            <c-col md="3" *ngIf="isAdmin">
              <div class="mb-3">
                <label cLabel for="medicoId" class="form-label">Médico</label>
                <select cFormSelect id="medicoId" formControlName="medicoId" class="form-select">
                  <option [value]="null">Todos os Médicos</option>
                  <option *ngFor="let medico of medicos" [value]="medico.id">
                    {{ medico.nome }} - {{ medico.crm }}
                  </option>
                </select>
              </div>
            </c-col>

            <!-- Year Selector -->
            <c-col md="3">
              <div class="mb-3">
                <label cLabel for="year" class="form-label">Ano</label>
                <select cFormSelect id="year" formControlName="year" class="form-select">
                  <option *ngFor="let year of years" [value]="year">{{ year }}</option>
                </select>
              </div>
            </c-col>
          </c-row>

          <!-- Action Buttons -->
          <c-row>
            <c-col xs="12">
              <button cButton color="primary" (click)="onApplyFilters()" class="me-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                  class="bi bi-search me-1" viewBox="0 0 16 16">
                  <path
                    d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                </svg>
                Aplicar Filtros
              </button>
              <button cButton color="secondary" variant="outline" (click)="onClearFilters()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                  class="bi bi-x-circle me-1" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                  <path
                    d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" />
                </svg>
                Limpar
              </button>
            </c-col>
          </c-row>
        </form>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>

<!-- Charts Section -->
<c-row>
  <!-- Billing by Procedure -->
  <c-col xs="12">
    <c-card class="mb-4 chart-card">
      <c-card-header class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0 fw-semibold">Faturamento por Procedimento</h5>
          <small class="text-muted">Análise detalhada por tipo de procedimento</small>
        </div>
        <div class="badge bg-primary-gradient">
          Total: {{ getTotalProcedure() | currency:'BRL':'symbol':'1.2-2' }}
        </div>
      </c-card-header>
      <c-card-body>
        <div *ngIf="loadingProcedure" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
        </div>
        <div *ngIf="!loadingProcedure && procedureData.length === 0" class="text-center py-5 text-muted">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-inbox mb-3"
            viewBox="0 0 16 16">
            <path
              d="M4.98 4a.5.5 0 0 0-.39.188L1.54 8H6a.5.5 0 0 1 .5.5 1.5 1.5 0 1 0 3 0A.5.5 0 0 1 10 8h4.46l-3.05-3.812A.5.5 0 0 0 11.02 4H4.98zm9.954 5H10.45a2.5 2.5 0 0 1-4.9 0H1.066l.32 2.562a.5.5 0 0 0 .497.438h12.234a.5.5 0 0 0 .496-.438L14.933 9zM3.809 3.563A1.5 1.5 0 0 1 4.981 3h6.038a1.5 1.5 0 0 1 1.172.563l3.7 4.625a.5.5 0 0 1 .105.374l-.39 3.124A1.5 1.5 0 0 1 14.117 13H1.883a1.5 1.5 0 0 1-1.489-1.314l-.39-3.124a.5.5 0 0 1 .106-.374l3.7-4.625z" />
          </svg>
          <p>Nenhum dado encontrado para os filtros selecionados</p>
        </div>
        <div *ngIf="!loadingProcedure && procedureData.length > 0" class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Procedimento</th>
                <th class="text-end">Valor Total</th>
                <th class="text-end">Percentual</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of procedureData">
                <td>{{ item.descricao }}</td>
                <td class="text-end fw-semibold">{{ item.total | currency:'BRL':'symbol':'1.2-2' }}</td>
                <td class="text-end">
                  <span class="badge bg-info-subtle text-info">
                    {{ (item.total / getTotalProcedure() * 100).toFixed(1) }}%
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>

<c-row>
  <!-- Billing by Payment Method -->
  <c-col xs="12" md="6">
    <c-card class="mb-4 chart-card">
      <c-card-header>
        <h5 class="mb-0 fw-semibold">Faturamento por Forma de Pagamento</h5>
        <small class="text-muted">Distribuição por método de pagamento</small>
      </c-card-header>
      <c-card-body>
        <div *ngIf="loadingPaymentMethod" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
        </div>
        <div *ngIf="!loadingPaymentMethod && paymentMethodChart.data?.labels?.length === 0"
          class="text-center py-5 text-muted">
          <p>Nenhum dado disponível</p>
        </div>
        <c-chart *ngIf="!loadingPaymentMethod && paymentMethodChart.data?.labels?.length > 0"
          [type]="paymentMethodChart.type" [data]="paymentMethodChart.data" [options]="paymentMethodChart.options"
          style="height: 300px;">
        </c-chart>
      </c-card-body>
    </c-card>
  </c-col>

  <!-- Billing by Payment Condition -->
  <c-col xs="12" md="6">
    <c-card class="mb-4 chart-card">
      <c-card-header>
        <h5 class="mb-0 fw-semibold">Faturamento por Condição de Pagamento</h5>
        <small class="text-muted">Distribuição por condição de pagamento</small>
      </c-card-header>
      <c-card-body>
        <div *ngIf="loadingPaymentCondition" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
        </div>
        <div *ngIf="!loadingPaymentCondition && paymentConditionChart.data?.labels?.length === 0"
          class="text-center py-5 text-muted">
          <p>Nenhum dado disponível</p>
        </div>
        <c-chart *ngIf="!loadingPaymentCondition && paymentConditionChart.data?.labels?.length > 0"
          [type]="paymentConditionChart.type" [data]="paymentConditionChart.data"
          [options]="paymentConditionChart.options" style="height: 300px;">
        </c-chart>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>

<c-row>
  <!-- Annual Billing -->
  <c-col xs="12">
    <c-card class="mb-4 chart-card">
      <c-card-header>
        <h5 class="mb-0 fw-semibold">Faturamento Anual</h5>
        <small class="text-muted">Evolução mensal do faturamento</small>
      </c-card-header>
      <c-card-body>
        <div *ngIf="loadingAnnual" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
        </div>
        <div *ngIf="!loadingAnnual && annualBillingChart.data?.labels?.length === 0"
          class="text-center py-5 text-muted">
          <p>Nenhum dado disponível</p>
        </div>
        <c-chart *ngIf="!loadingAnnual && annualBillingChart.data?.labels?.length > 0" [type]="annualBillingChart.type"
          [data]="annualBillingChart.data" [options]="annualBillingChart.options" style="height: 350px;">
        </c-chart>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>